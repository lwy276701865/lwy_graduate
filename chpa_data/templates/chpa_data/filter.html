<div class="ui container">
    <div class="ui form">
        <form action="" method="post" enctype="multipart/form-data">
            <!-- 在Django所有的 POST 表单元素时，需要加上下方的csrf_token tag，主要是安全方面的机制，本例后续使用AJAX方法，这里的POST class和token都不生效 -->
            {% csrf_token %}
            {#            导入文件区域#}
            <input type="file" name="upload" accept="text/csv" />
            <input  class="ui fluid large blue submit button" type="submit" value="导入" >
            <div class="ui info message">{{ message}}</div>

            {#    分析维度区域#}
            <h3 class="ui header" id="analysis">分析维度</h3>
            <div class="field">
                {#            选择index#}
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4>选择index</h4>
                        <select name="INDEX_select" id="INDEX_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
                            {#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict.items %}
                                <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {#                选择column#}
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4>选择column</h4>
                        <select name="DIMENSION_select" id="DIMENSION_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
                            {#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict.items %}
                                <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {#            选择value#}
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4>选择value</h4>
                        <select name="VALUE_select" id="VALUE_select" class="ui fluid search dropdown">
                            <option value="" style="display: none"></option>
                            {#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict_value.items %}
                                <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {#                选择aggfunc#}
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4>选择运算方法</h4>
                        <select name="AGGFUNC_select" id="AGGFUNC_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
                            {% for key, value in aggfunc_select.items %}
                                <option value="{{ value }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            {#        数据筛选区域#}
            <h3 class="ui header" id="data_filter">数据筛选</h3>
            <div class="field">
                {% for key, value in mselect_dict.items %}
                    <div class="field">
                        {#                      为什么<select name>要加个后缀[]？这是因为以后在jQuery传参时多选控件#}
                        {#                     （实际就是传送array而不是单个变量的控件）的<select name>在很多场景下必须以[]结尾才能 #}
                        {#                      正确工作。但有时[]也不是必须的。#}
                        <select name="{{ value.select|add:"_select[]" }}" id="{{ value.select|add:"_select" }}" multiple=""
                                class="ui fluid search dropdown">
                            <option value="">{{ key }}</option>
                            {% for item in value.options %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
            </div>
            <br>
            {#        查询按钮#}
            <div class="ui buttons">
                <input class="ui blue button" type='button' id='AJAX_get' value="查询"/>
            </div>
        </form>
    </div>
</div>

<!-- 因为用到Semantic UI的Search Dropdown控件，必须有下面语句初始化 -->
<script>
    $('.ui.fluid.search.dropdown')
        .dropdown({ fullTextSearch: true });
</script>

{#ajax异步传参相关函数#}
<script type="text/javascript">
    $("#AJAX_get").click(function (event) {
        event.preventDefault(); // 防止表单默认的提交
        var form_data = getForm()
        if(form_data['DIMENSION_select']==''||
            form_data['VALUE_select']==''||
            form_data['INDEX_select']==''||
            form_data['AGGFUNC_select']=='')
        {
            alert('维度不允许取空值')
            return false;
        }
        if(form_data['DIMENSION_select']==form_data['INDEX_select']||
            form_data['DIMENSION_select']==form_data['VALUE_select']||
            form_data['VALUE_select']==form_data['INDEX_select'])
        {
            alert('维度不允许取重复值')
            return false;
        }

        var dimmer = $("#dimmer");
        dimmer.attr('class', 'ui active dimmer'); // 点击筛选按钮后dimmer变成active
        dimmer.children('pre').remove(); // 删除初始化文字
        dimmer.append('<div class="ui text loader">数据加载中……</div>'); // 增加loading效果和文字
        var info_chart = echarts.init(document.getElementById('info_chart'), 'white', {renderer: 'canvas'});
        info_chart.showLoading({
            text: '正在加载数据'
        });  //增加加载提示

        // Pyecharts图表初始化
        var pivot_chart = echarts.init(document.getElementById('pivot_chart'), 'white', {renderer: 'canvas'});
        pivot_chart.showLoading({
            text : '正在加载数据'
        });  //增加加载提示

        var origin_data_chart = echarts.init(document.getElementById('origin_data_chart'), 'white', {renderer: 'canvas'});
        origin_data_chart.showLoading({
            text : '正在加载数据'
        });  //增加加载提示
        $.ajax({
            // 请求的url
            url: '{% url 'chpa:query' %}',
            // 请求的type
            type: 'GET',
            // 发送的数据
            data: form_data,
            // 回调函数，其中ret是返回的JSON，可以以字典的方式调用
            success: function (ret) {     //成功执行
                {# 初始化透视表格 #}
                $("#result_table").html(ret['ptable']);//这个ptable是后端query函数传过来的ptable
                initTable($("#ptable")) // 为id为ptable的DOM表格初始化DataTables，即上一行刚刚修改了DOM元素的那个

                {# 初始化原数据表格 #}
                $("#initdata_result_table").html(ret['initdata_table']);
                initTable($("#initdata_table"))

                // 去除加载遮罩（去掉active）
                dimmer.attr('class', 'ui dimmer');

                // 展示Pyecharts图
                info_chart.clear();
                info_chart.setOption(ret['info_chart']);
                info_chart.hideLoading()

                pivot_chart.clear();
                pivot_chart.setOption(ret['pivot_chart']);
                pivot_chart.hideLoading()

                origin_data_chart.clear();
                origin_data_chart.setOption(ret['origin_data_chart']);
                origin_data_chart.hideLoading()
            },
            error: function (xhr, textStatus, errorThrown) {
                dimmer.children('div').text("错误信息："+errorThrown);
            }
        });
    })
</script>

{#初始化表格#}
<script>
    function initTable(table) {
        table.DataTable(
            {
                {#order: [[1, "desc"]], // 初始以第2列（注意第一列索引为0）由高到低排序#}
                pageLength: 25, // 前端分页，初始每页显示25条记录
                autoWidth: false, // 不自动调整表格宽度
                oLanguage: { // UI Label本地化
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sProcessing": "处理中...",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 条结果，共 _TOTAL_ 条",
                    "sInfoEmpty": "没有数据",
                    "sInfoFiltered": "(获取 _MAX_ 条客户档案)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                },
            }
        );
    }
</script>

{#获取前端选择的表单结果，即用户选择了哪些数据#}
<script>
    function getForm(){
        // 获取单选下拉框的值
        var form_data = {
            "DIMENSION_select": $("#DIMENSION_select").val(),
            "VALUE_select": $("#VALUE_select").val(),
            "INDEX_select": $("#INDEX_select").val(),
            "AGGFUNC_select":$("#AGGFUNC_select").val()
        };

        // 获取多选下拉框的值（index和column）
        var dict = {{ mselect_dict|safe }};
        for (key in dict) {
            var form_name = dict[key]['select'] + "_select";
            jquery_selector_id = "[id='" + form_name + "']";//因为我们的部分多选框id有空格，要用这种写法
            form_data[form_name] = $(jquery_selector_id).val();
        }
        // 获取value下拉框的值
        var dict2 = {{ mselect_dict_value|safe }};
        for (key in dict2) {
            var form_name = dict2[key]['select'] + "_select";
            jquery_selector_id = "[id='" + form_name + "']";//因为我们的部分多选框id有空格，要用这种写法
            form_data[form_name] = $(jquery_selector_id).val();
        }
        return form_data
    }
</script>
