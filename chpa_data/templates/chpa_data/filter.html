{#{% %}是功能标签，而{{ }}是变量标签#}


{# 在filter.html的JS部分（注意因为Django模板的继承特性，他们是互通的，也就是filter.html的JS代码能控制display.html#}
{# 的DOM）#}

<div class="ui container">
    <div class="ui form">
        <form action="" method="post" enctype="multipart/form-data">
            <!-- 在Django所有的 POST 表单元素时，需要加上下方的csrf_token tag，主要是安全方面的机制，本例后续使用AJAX方法，这里的POST class和token都不生效 -->
            {% csrf_token %}
            <input type="file" name="upload" accept="text/csv" />
            <input  class="ui fluid large blue submit button" type="submit" value="导入" >
            <div class="ui info message">{{ message}}</div>
            <h3 class="ui header" id="analysis">分析维度</h3>
            <div class="field">
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4 class="ui header" id="pivoted_index">pick_index</h4>
                        <select name="INDEX_select" id="INDEX_select" class="ui fluid search dropdown">
                            <option value="" style="display: none"></option>
{#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict.items %}
{#                                    <option> 标签的value属性定义送往服务器的选项值。#}
{#                                    <option> 标签里有selected表示该选项最初处于选中状态#}
                                    <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4 class="ui header" id="pivoted_column">pick_column</h4>
                        <select name="COLUMN_select" id="COLUMN_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
{#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict.items %}
                                <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4 class="ui header" id="pivoted_value">pick_VALUE</h4>
                        <select name="VALUE_select" id="VALUE_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
{#                            <option value="0">请选择</option>#}
                            {% for key, value in mselect_dict_value.items %}
                                <option value="{{ value.select }}">{{ key }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="fields">
                    <div class="sixteen wide field">
                        <h4 class="ui header" id="pivoted_value">选择汇总方式</h4>
                        <select name="AGG_select" id="AGG_select" class="ui fluid search dropdown" >
                            <option value="" style="display: none"></option>
                            {#                            <option value="0">请选择</option>#}
                            <option value="mysum">求和</option>
                            <option value="myavg">平均</option>
                            <option value="mymax">最大值</option>
                            <option value="mymin">最小值</option>
                            <option value="mybzc">标准差</option>
                            <option value="myfc">方差</option>
                            <option value="mymid">中位数</option>
                        </select>
                    </div>
                </div>
            </div>
            <h3 class="ui header" id="data_filter">数据筛选</h3>
            <div class="field">
                {% for key, value in mselect_dict.items %}
                    <div class="field">
{#                       为什么<select name>要加个后缀[]？这是因为以后在jQuery传参时多选控件（实际就是传送 #}
{#                       array而不是单个变量的控件）的<select name>在很多场景下（如后续章节介绍的AJAX异步传参） #}
{#                           必须以[]结尾才能正确工作。但有时[]也不是必须的。#}
{#                        竖杠后面的部分是竖杠前方tag的filter，冒号后面部分则为这个filter的参数：#}
                        <select name="{{ value.select|add:"_select[]" }}" id="{{ value.select|add:"_select" }}" multiple=""
                                class="ui fluid search dropdown">
                            <option value="">{{ key }}</option>
                            {% for item in value.options %}
                                <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
            </div>
            <br>{#换行符#}

            <div class="ui buttons">
                <input class="ui blue button" type='button' id='AJAX_get' value="查询"/>
            </div>
        </form>
    </div>
</div>
{#初始化表格#}
<script>
    <!-- 因为用到Semantic UI的Search Dropdown控件，必须有下面语句初始化 -->
    $('.ui.fluid.search.dropdown')
        .dropdown({ fullTextSearch: true });
    function initTable(table) {
        table.DataTable(
            {
                pageLength: 25, // 前端分页，初始每页显示25条记录
                autoWidth: false, // 不自动调整表格宽度
                oLanguage: { // UI Label本地化
                    "sLengthMenu": "显示 _MENU_ 项结果",
                    "sProcessing": "处理中...",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "显示第 _START_ 至 _END_ 条结果，共 _TOTAL_ 条",
                    "sInfoEmpty": "没有数据",
                    "sInfoFiltered": "(获取 _MAX_ 条客户档案)",
                    "sInfoPostFix": "",
                    "sSearch": "搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                },
            }
        );
    }
</script>
<script type="text/javascript">
    $("#AJAX_get").click(function (event) {
        event.preventDefault(); // 防止表单默认的提交
        var form_data=getForm();
        // Pyecharts图表初始化
        {#var chart = echarts.init(document.getElementById('bar_total_trend'), 'white', {renderer: 'canvas'});#}
        {#chart.showLoading({#}
        {#    text : '正在加载数据'#}
        {# });  //增加加载提示#}

        var dimmer = $("#dimmer");
        dimmer.attr('class', 'ui active dimmer'); // 点击筛选按钮后dimmer变成active
        dimmer.children('div').remove(); // 删除初始化文字
        dimmer.append('<div class="ui text loader">数据加载中……</div>'); // 增加loading效果和文字

        $.ajax({
            // 请求的url
            url: '{% url 'chpa:query' %}',
            // 请求的type
            type: 'GET',
            // 发送的数据
            data: form_data,
            // 回调函数，其中ret是返回的JSON，可以以字典的方式调用
            {#  该函数决定返回的结果怎么处理。我们选择把结果更新到之前模板预留id的DOM元素中  #}
            success: function (ret) {
                // 去除加载遮罩（去掉active）
                dimmer.attr('class', 'ui dimmer');//成功执行
                // 更新单位标签
                $("#label_size_unit").html("最新"+form_data['PERIOD_select']+ " " +form_data['UNIT_select']);
                // 把查询结果输出到网页上预留id的DOM元素中
                $("#value_size").html(ret["market_size"].toLocaleString());
                $("#value_gr").html(ret["market_gr"].toLocaleString());
                $("#value_cagr").html(ret["market_cagr"].toLocaleString());
                $("#result_table").html(ret['valuecount_table']);//后端传过来的ptable
                initTable($("#valuecount_table")) // 为id为ptable的DOM表格初始化DataTables，display里第二个tab中的ptable

                $("#result_table").html(ret['describe_table']);//后端传过来的ptable
                initTable($("#describe_table")) // 为id为ptable的DOM表格初始化DataTables，display里第二个tab中的ptable

                $("#result_table").html(ret['mypivot_table']);//后端传过来的ptable
                initTable($("#mypivot_table")) // 为id为ptable的DOM表格初始化DataTables，display里第二个tab中的ptable

                // 展示Pyecharts整体市场柱状组合图
                {#chart.clear();#}
                {#chart.setOption(ret['bar_total_trend']);#}
                {#chart.hideLoading();#}
                {##}
                {#// 展示Matplotlib气泡图#}
                {#$("#bubble_performance").attr('src', ret['bubble_performance']);#}
            },
            error: function () {            //失败
                dimmer.children('div').text('有错误发生，无法完成查询'); // AJAX回调失败则报错
                console.log('失败')
            }
        });
    })
</script>

{# 获取前端用户选择的筛选条件 #}
<script>
    function getForm(){
        // 获取单选下拉框的值
        var form_data = {
            {#   $符号匹配id     #}
            "INDEX_select": $("#INDEX_select").val(),
            "COLUMN_select": $("#COLUMN_select").val(),
            "VALUE_select": $("#VALUE_select").val(),
            "AGG_select": $("#AGG_select").val(),
        };
        // 获取多选下拉框的值(index和column)
        var dict = {{ mselect_dict|safe }};
        for (key in dict) {
            var form_name = dict[key]['select'] + "_select";
            jquery_selector_id = "[id='" + form_name + "']";//因为我们的部分多选框id有空格，要用这种写法
            form_data[form_name] = $(jquery_selector_id).val();
        }
        //获取value下拉框的值
        var dict_value = {{ mselect_dict|safe }};
        for (key in dict_value) {
            var form_name = dict_value[key]['select'] + "_select";
            jquery_selector_id = "[id='" + form_name + "']";//因为我们的部分多选框id有空格，要用这种写法
            form_data[form_name] = $(jquery_selector_id).val();
        }
        return form_data
    }
</script>




